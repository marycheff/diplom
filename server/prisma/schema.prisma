generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(uuid())
  email          String        @unique
  name           String?
  surname        String?
  patronymic     String?
  password       String
  isActivated    Boolean       @default(false)
  role           Role          @default(USER)
  activationLink String?
  resetCode      String?
  isBlocked      Boolean       @default(false)
  refreshToken   Token?
  testsCreated   Test[]        @relation("TestAuthor")
  testAttempts   TestAttempt[] @relation("TestAttemptUser")
  badWordsAdded  BadWord[]     @relation("AddedByUser")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("users")
}

model Token {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("tokens")
}

model TestSettings {
  id                  String   @id @default(uuid())
  testId              String   @unique
  test                Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  requireRegistration Boolean  @default(false)
  inputFields         Json?
  requiredFields      Json?
  showDetailedResults Boolean  @default(false)
  timeLimit           Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("test_settings")
}

model Test {
  id            String           @id @default(uuid())
  authorId      String
  author        User             @relation("TestAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  status        ModerationStatus @default(PENDING)
  totalAttempts Int              @default(0)
  questions     Question[]
  settings      TestSettings?
  testAttempts  TestAttempt[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@map("tests")
}

model Question {
  id          String       @id @default(uuid())
  testId      String
  test        Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  text        String
  order       Int
  type        QuestionType @default(SINGLE_CHOICE)
  answers     Answer[]
  userAnswers UserAnswer[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("questions")
}

model Answer {
  id          String       @id @default(uuid())
  questionId  String
  question    Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  text        String
  isCorrect   Boolean      @default(false)
  isGenerated Boolean      @default(false)
  userAnswers UserAnswer[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("answers")
}

model TestAttempt {
  id          String            @id @default(uuid())
  testId      String
  test        Test              @relation(fields: [testId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?             @relation("TestAttemptUser", fields: [userId], references: [id], onDelete: SetNull)
  userData    Json?
  score       Float?
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  status      TestAttemptStatus
  answers     UserAnswer[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("test_attempts")
}

model UserAnswer {
  id         String      @id @default(uuid())
  attemptId  String
  attempt    TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId String
  question   Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answerId   String
  answer     Answer      @relation(fields: [answerId], references: [id], onDelete: Cascade)
  answeredAt DateTime?
  timeSpent  Int?
  createdAt  DateTime    @default(now())

  @@map("user_answers")
}

model BadWord {
  id        String   @id @default(uuid())
  word      String   @unique
  addedById String
  addedBy   User     @relation("AddedByUser", fields: [addedById], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bad_words")
}

enum Role {
  USER
  ADMIN
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TestAttemptStatus {
  EXPIRED
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
}